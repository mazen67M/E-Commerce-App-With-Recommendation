@model Ecommerce.Application.ViewModels.ProductDetailsViewModel
@{
    ViewData["Title"] = Model.Product.Name;
}

@Html.AntiForgeryToken()

<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
            <li class="breadcrumb-item"><a asp-controller="Product" asp-action="Index">Products</a></li>
            <li class="breadcrumb-item active" aria-current="page">@Model.Product.Name</li>
        </ol>
    </nav>
    <!-- Product Details -->
    <div class="row mb-5">
        <!-- Product Image with Zoom -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="position-relative product-image-container" id="imageContainer">
                    @if (!string.IsNullOrEmpty(Model.Product.ImageURL))
                    {
                        <img src="@Model.Product.ImageURL" class="card-img-top product-main-image" alt="@Model.Product.Name" 
                             style="height: 500px; object-fit: cover; cursor: zoom-in;" id="productImage"
                             onclick="openImageModal()" onmousemove="zoomImage(event)" onmouseleave="resetZoom()">
                        <div class="zoom-lens" id="zoomLens"></div>
                        <small class="position-absolute bottom-0 start-0 m-2 text-white bg-dark bg-opacity-50 px-2 py-1 rounded">
                            <i class="bi bi-zoom-in"></i> Click or hover to zoom
                        </small>
                    }
                    else
                    {
                        <div class="card-img-top d-flex align-items-center justify-content-center bg-light" 
                             style="height: 500px;">
                            <i class="bi bi-image text-muted" style="font-size: 5rem;"></i>
                        </div>
                    }
                    
                    @if (!Model.Product.IsAvailable)
                    {
                        <div class="position-absolute top-0 end-0 m-3">
                            <span class="badge bg-danger fs-6">Out of Stock</span>
                        </div>
                    }
                    else if (Model.Product.StockQuantity <= 5 && Model.Product.StockQuantity > 0)
                    {
                        <div class="position-absolute top-0 end-0 m-3">
                            <span class="badge bg-warning fs-6">Only @Model.Product.StockQuantity left!</span>
                        </div>
                    }
                </div>
                
                <!-- Image Gallery Thumbnails -->
                @if (Model.Product.Images != null && Model.Product.Images.Any())
                {
                    <div class="card-footer bg-white">
                        <div class="d-flex gap-2 overflow-auto py-2" id="imageThumbnails">
                            <!-- Main Image Thumbnail -->
                            <div class="gallery-thumb active" onclick="changeMainImage('@Model.Product.ImageURL', this)">
                                <img src="@Model.Product.ImageURL" alt="Main" 
                                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer;">
                            </div>
                            @foreach (var img in Model.Product.Images.OrderBy(i => i.DisplayOrder))
                            {
                                <div class="gallery-thumb" onclick="changeMainImage('@img.ImageURL', this)">
                                    <img src="@img.ImageURL" alt="@(img.AltText ?? "Product Image")" 
                                         style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer;">
                                </div>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <!-- Placeholder gallery when no additional images -->
                    <div class="card-footer bg-white">
                        <div class="d-flex gap-2 py-2">
                            <div class="gallery-thumb active">
                                <img src="@Model.Product.ImageURL" alt="Main" 
                                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; opacity: 0.7;">
                            </div>
                            <div class="d-flex align-items-center text-muted small">
                                <i class="bi bi-images me-1"></i> No additional images
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

<!-- Image Zoom Modal with Gallery -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body p-0 text-center position-relative">
                <img src="@Model.Product.ImageURL" class="img-fluid rounded shadow-lg" alt="@Model.Product.Name" 
                     style="max-height: 80vh; cursor: zoom-out;" id="modalImage" onclick="closeImageModal()">
                
                <!-- Modal Navigation -->
                @if (Model.Product.Images != null && Model.Product.Images.Any())
                {
                    <button type="button" class="btn btn-dark position-absolute start-0 top-50 translate-middle-y ms-3" 
                            onclick="prevModalImage()">
                        <i class="bi bi-chevron-left fs-4"></i>
                    </button>
                    <button type="button" class="btn btn-dark position-absolute end-0 top-50 translate-middle-y me-3" 
                            onclick="nextModalImage()">
                        <i class="bi bi-chevron-right fs-4"></i>
                    </button>
                }
                
                <button type="button" class="btn btn-light btn-sm position-absolute top-0 end-0 m-3" 
                        onclick="closeImageModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
                
                <!-- Modal Thumbnails -->
                @if (Model.Product.Images != null && Model.Product.Images.Any())
                {
                    <div class="d-flex justify-content-center gap-2 mt-3">
                        <div class="modal-thumb active" onclick="setModalImage('@Model.Product.ImageURL', 0)">
                            <img src="@Model.Product.ImageURL" alt="Main" 
                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer;">
                        </div>
                        @{ var imgIndex = 1; }
                        @foreach (var img in Model.Product.Images.OrderBy(i => i.DisplayOrder))
                        {
                            <div class="modal-thumb" onclick="setModalImage('@img.ImageURL', @imgIndex)">
                                <img src="@img.ImageURL" alt="@(img.AltText ?? "Image")" 
                                     style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer;">
                            </div>
                            imgIndex++;
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>


        <!-- Product Information -->
        <div class="col-lg-6">
            <div class="h-100">
                <!-- Product Name -->
                <h1 class="display-5 fw-bold text-primary mb-3">@Model.Product.Name</h1>

                <!-- Category and Brand -->
                <div class="mb-3">
                    <span class="badge bg-secondary me-2">
                        <i class="bi bi-tag"></i> @Model.Product.CategoryName
                    </span>
                    @if (!string.IsNullOrEmpty(Model.Product.BrandName))
                    {
                        <span class="badge bg-info">
                            <i class="bi bi-building"></i> @Model.Product.BrandName
                        </span>
                    }
                </div>

                <!-- Rating -->
                @if (Model.Product.AverageRating > 0)
                {
                    <div class="mb-3">
                        <div class="d-flex align-items-center">
                            @for (int i = 1; i <= 5; i++)
                            {
                                @if (i <= Model.Product.AverageRating)
                                {
                                    <i class="bi bi-star-fill text-warning fs-5"></i>
                                }
                                else if (i - 0.5 <= Model.Product.AverageRating)
                                {
                                    <i class="bi bi-star-half text-warning fs-5"></i>
                                }
                                else
                                {
                                    <i class="bi bi-star text-muted fs-5"></i>
                                }
                            }
                            <span class="ms-2 text-muted">
                                (@Model.Product.AverageRating.ToString("F1")) 
                                @if (Model.Product.ReviewCount > 0)
                                {
                                    <span>â€¢ @Model.Product.ReviewCount review@(Model.Product.ReviewCount != 1 ? "s" : "")</span>
                                }
                            </span>
                        </div>
                    </div>
                }

                <!-- Price -->
                <div class="mb-4">
                    <h2 class="text-success fw-bold">@Model.Product.Price.ToString("N2") L.E</h2>
                </div>

                <!-- Description -->
                @if (!string.IsNullOrEmpty(Model.Product.Description))
                {
                    <div class="mb-4">
                        <h5 class="fw-bold">Description</h5>
                        <p class="text-muted">@Model.Product.Description</p>
                    </div>
                }

                <!-- Availability Status -->
                <div class="mb-4">
                    <h6 class="fw-bold">Availability</h6>
                    @if (Model.Product.IsAvailable)
                    {
                        <span class="badge bg-success fs-6">
                            <i class="bi bi-check-circle"></i> In Stock
                        </span>
                    }
                    else
                    {
                        <span class="badge bg-danger fs-6">
                            <i class="bi bi-x-circle"></i> Out of Stock
                        </span>
                    }
                </div>

                <!-- Product Variants (Size, Color, etc.) -->
                @if (Model.Product.Variants != null && Model.Product.Variants.Any())
                {
                    <!-- Group variants by type -->
                    @foreach (var variantGroup in Model.Product.Variants.GroupBy(v => v.VariantType))
                    {
                        <div class="mb-4">
                            <h6 class="fw-bold">@variantGroup.Key</h6>
                            <div class="d-flex flex-wrap gap-2">
                                @foreach (var variant in variantGroup.OrderBy(v => v.DisplayOrder))
                                {
                                    var isColorVariant = variantGroup.Key.Equals("Color", StringComparison.OrdinalIgnoreCase);
                                    var priceLabel = variant.PriceAdjustment > 0 ? $"+{variant.PriceAdjustment:N0} L.E" : 
                                                    variant.PriceAdjustment < 0 ? $"{variant.PriceAdjustment:N0} L.E" : "";
                                    
                                    if (isColorVariant && !string.IsNullOrEmpty(variant.ColorCode))
                                    {
                                        <button type="button" class="btn btn-outline-secondary variant-btn @(variant.IsAvailable ? "" : "disabled")" 
                                                data-variant-id="@variant.VariantID" 
                                                data-variant-type="@variant.VariantType"
                                                data-variant-value="@variant.VariantValue"
                                                data-price-adjustment="@variant.PriceAdjustment"
                                                onclick="selectVariant(this)"
                                                @(variant.IsAvailable ? "" : "disabled")>
                                            <span class="d-inline-block rounded-circle me-1" 
                                                  style="width: 20px; height: 20px; background-color: @variant.ColorCode; border: 2px solid #ccc;"></span>
                                            @variant.VariantValue
                                            @if (!string.IsNullOrEmpty(priceLabel))
                                            {
                                                <small class="text-muted">(@priceLabel)</small>
                                            }
                                            @if (!variant.IsAvailable)
                                            {
                                                <small class="text-danger">(Out)</small>
                                            }
                                        </button>
                                    }
                                    else
                                    {
                                        <button type="button" class="btn btn-outline-secondary variant-btn @(variant.IsAvailable ? "" : "disabled")" 
                                                data-variant-id="@variant.VariantID" 
                                                data-variant-type="@variant.VariantType"
                                                data-variant-value="@variant.VariantValue"
                                                data-price-adjustment="@variant.PriceAdjustment"
                                                onclick="selectVariant(this)"
                                                @(variant.IsAvailable ? "" : "disabled")>
                                            @variant.VariantValue
                                            @if (!string.IsNullOrEmpty(priceLabel))
                                            {
                                                <small class="text-muted">(@priceLabel)</small>
                                            }
                                            @if (!variant.IsAvailable)
                                            {
                                                <small class="text-danger">(Out)</small>
                                            }
                                        </button>
                                    }
                                }
                            </div>
                        </div>
                    }
                    <input type="hidden" id="selectedVariants" value="" />
                }

                <!-- Action Buttons -->
                <div class="d-grid gap-2 d-md-block">
                    @if (Model.Product.IsAvailable)
                    {
                        <button type="button" id="addToCartBtn" class="btn btn-primary btn-lg me-2" onclick="addToCart(@Model.Product.ProductID)">
                            <i class="bi bi-cart-plus"></i> Add to Cart
                        </button>
                        <button type="button" id="buyNowBtn" class="btn btn-outline-secondary btn-lg me-2" onclick="buyNow(@Model.Product.ProductID)">
                            <i class="bi bi-lightning"></i> Buy Now
                        </button>
                    }
                    
                    <button type="button" id="wishlistBtn" class="btn btn-outline-danger btn-lg" onclick="toggleWishlist(@Model.Product.ProductID, this)">
                        <i class="bi @(Model.IsInWishlist ? "bi-heart-fill" : "bi-heart")" id="wishlistIcon"></i> 
                        <span id="wishlistText">@(Model.IsInWishlist ? "Remove from Wishlist" : "Add to Wishlist")</span>
                    </button>
                </div>
                
                <!-- Loading Spinner (Hidden by default) -->
                <div id="actionSpinner" class="d-none mt-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Processing...</span>
                </div>

                <!-- Share Buttons -->
                <div class="mt-4">
                    <h6 class="fw-bold">Share this product</h6>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="shareProduct('facebook')">
                            <i class="bi bi-facebook"></i>
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="shareProduct('twitter')">
                            <i class="bi bi-twitter"></i>
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="shareProduct('whatsapp')">
                            <i class="bi bi-whatsapp"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="copyLink()">
                            <i class="bi bi-link-45deg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Tags -->
    @if (Model.Product.Tags != null && Model.Product.Tags.Any())
    {
        <div class="row mb-5">
            <div class="col-12">
                <h5 class="fw-bold mb-3">Tags</h5>
                <div>
                    @foreach (var tag in Model.Product.Tags)
                    {
                        <span class="badge bg-light text-dark me-2 mb-2">#@tag</span>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Recommended Products -->
    @if (Model.RecommendedProducts.Any())
    {
        <div class="row mb-5">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="fw-bold">You might also like</h3>
                    <a asp-action="Index" class="btn btn-outline-primary">View All Products</a>
                </div>
                
                <div class="row">
                    @foreach (var product in Model.RecommendedProducts)
                    {
                        <div class="col-lg-3 col-md-6 mb-4">
                            <div class="card h-100 shadow-sm product-card">
                                <!-- Product Image -->
                                <div class="position-relative">
                                    @if (!string.IsNullOrEmpty(product.ImageURL))
                                    {
                                        <img src="@product.ImageURL" class="card-img-top product-image" alt="@product.Name" 
                                             style="height: 200px; object-fit: cover;">
                                    }
                                    else
                                    {
                                        <div class="card-img-top d-flex align-items-center justify-content-center bg-light" 
                                             style="height: 200px;">
                                            <i class="bi bi-image text-muted" style="font-size: 2rem;"></i>
                                        </div>
                                    }
                                    
                                    @if (!product.IsAvailable)
                                    {
                                        <div class="position-absolute top-0 end-0 m-2">
                                            <span class="badge bg-danger">Out of Stock</span>
                                        </div>
                                    }
                                </div>

                                <!-- Product Info -->
                                <div class="card-body d-flex flex-column">
                                    <h6 class="card-title text-truncate" title="@product.Name">@product.Name</h6>
                                    
                                    <!-- Rating -->
                                    @if (product.AverageRating > 0)
                                    {
                                        <div class="mb-2">
                                            <div class="d-flex align-items-center">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    @if (i <= product.AverageRating)
                                                    {
                                                        <i class="bi bi-star-fill text-warning small"></i>
                                                    }
                                                    else if (i - 0.5 <= product.AverageRating)
                                                    {
                                                        <i class="bi bi-star-half text-warning small"></i>
                                                    }
                                                    else
                                                    {
                                                        <i class="bi bi-star text-muted small"></i>
                                                    }
                                                }
                                                <small class="text-muted ms-1">(@product.AverageRating.ToString("F1"))</small>
                                            </div>
                                        </div>
                                    }

                                    <!-- Price and Actions -->
                                    <div class="mt-auto">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="text-primary mb-0">@product.Price.ToString("N2") L.E</h6>
                                            <a asp-action="Details" asp-route-id="@product.ProductID" 
                                               class="btn btn-outline-primary btn-sm">
                                                View
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Reviews Section -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Customer Reviews</h4>
                        <div id="averageRatingDisplay" class="d-flex align-items-center">
                            <div class="text-warning me-2" id="avgStars"></div>
                            <span class="fw-bold" id="avgRatingText">0.0</span>
                            <span class="text-muted ms-2">(<span id="reviewCountText">0</span> reviews)</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Reviews List -->
                    <div id="reviewsContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Add Review Form (Only for authenticated users) -->
                    @if (User.Identity.IsAuthenticated)
                    {
                        <div class="mt-4 pt-4 border-top">
                            <h5 class="mb-3">Write a Review</h5>
                            <form id="reviewForm">
                                @Html.AntiForgeryToken()
                                <input type="hidden" id="productId" value="@Model.Product.ProductID">
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Your Rating</label>
                                    <div class="rating-input">
                                        <i class="bi bi-star fs-4 text-muted" data-rating="1" onclick="setRating(1)"></i>
                                        <i class="bi bi-star fs-4 text-muted" data-rating="2" onclick="setRating(2)"></i>
                                        <i class="bi bi-star fs-4 text-muted" data-rating="3" onclick="setRating(3)"></i>
                                        <i class="bi bi-star fs-4 text-muted" data-rating="4" onclick="setRating(4)"></i>
                                        <i class="bi bi-star fs-4 text-muted" data-rating="5" onclick="setRating(5)"></i>
                                    </div>
                                    <input type="hidden" id="rating" name="rating" value="0">
                                    <small class="text-danger d-none" id="ratingError">Please select a rating</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="comment" class="form-label fw-bold">Your Review</label>
                                    <textarea class="form-control" id="comment" name="comment" rows="4" 
                                              placeholder="Share your experience with this product..." required></textarea>
                                    <small class="text-danger d-none" id="commentError">Please write a review</small>
                                </div>
                                
                                <button type="submit" class="btn btn-primary" id="submitReviewBtn">
                                    <i class="bi bi-send"></i> Submit Review
                                </button>
                            </form>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info mt-4">
                            <i class="bi bi-info-circle"></i> Please <a href="@Url.Action("Login", "Account")" class="alert-link">login</a> to write a review.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Show loading spinner during AJAX operations
        function showLoading() {
            document.getElementById('actionSpinner').classList.remove('d-none');
        }
        
        // Hide loading spinner after AJAX operations
        function hideLoading() {
            document.getElementById('actionSpinner').classList.add('d-none');
        }
        
        // Add to cart with AJAX
        function addToCart(productId) {
            showLoading();
            const btn = document.getElementById('addToCartBtn');
            btn.disabled = true;
            
            $.ajax({
                url: '@Url.Action("AddToCart", "Product")',
                type: 'POST',
                data: { productId: productId, quantity: 1 },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        // Show success notification
                        showNotification(response.message, 'success');
                        
                        // Update cart count in navbar
                        updateCartCount();
                        
                        // Visual feedback
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<i class="bi bi-check-circle"></i> Added to Cart';
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }, 2000);
                    } else {
                        if (response.message && response.message.includes('authenticated')) {
                            showNotification('Please login to add items to cart', 'warning');
                            setTimeout(function() {
                                window.location.href = '@Url.Action("Login", "Account")';
                            }, 1500);
                        } else {
                            showNotification(response.message || 'Error adding to cart', 'error');
                        }
                        btn.disabled = false;
                    }
                },
                error: function(xhr) {
                    console.error('Cart error:', xhr);
                    showNotification('Failed to add product to cart. Please try again.', 'error');
                    btn.disabled = false;
                },
                complete: function() {
                    hideLoading();
                }
            });
        }

        function buyNow(productId) {
            showLoading();
            const btn = document.getElementById('buyNowBtn');
            btn.disabled = true;
            
            $.ajax({
                url: '@Url.Action("AddToCart", "Product")',
                type: 'POST',
                data: { productId: productId, quantity: 1 },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        window.location.href = '@Url.Action("Index", "Cart")';
                    } else {
                        if (response.message && response.message.includes('authenticated')) {
                            showNotification('Please login to continue', 'warning');
                            setTimeout(function() {
                                window.location.href = '@Url.Action("Login", "Account")';
                            }, 1500);
                        } else {
                            showNotification(response.message || 'Error processing request', 'error');
                        }
                        btn.disabled = false;
                        hideLoading();
                    }
                },
                error: function(xhr) {
                    console.error('Buy now error:', xhr);
                    showNotification('Failed to process request. Please try again.', 'error');
                    btn.disabled = false;
                    hideLoading();
                }
            });
        }

        function toggleWishlist(productId, button) {
            showLoading();
            const wishlistIcon = document.getElementById('wishlistIcon');
            const wishlistText = document.getElementById('wishlistText');
            button.disabled = true;
            
            $.ajax({
                url: '@Url.Action("ToggleWishlist", "Product")',
                type: 'POST',
                data: { productId: productId },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        if (response.isInWishlist) {
                            wishlistIcon.classList.remove('bi-heart');
                            wishlistIcon.classList.add('bi-heart-fill');
                            wishlistText.textContent = 'Remove from Wishlist';
                            showNotification('Added to wishlist', 'success');
                        } else {
                            wishlistIcon.classList.remove('bi-heart-fill');
                            wishlistIcon.classList.add('bi-heart');
                            wishlistText.textContent = 'Add to Wishlist';
                            showNotification('Removed from wishlist', 'info');
                        }
                    } else {
                        if (response.message && response.message.includes('authenticated')) {
                            showNotification('Please login to manage wishlist', 'warning');
                            setTimeout(function() {
                                window.location.href = '@Url.Action("Login", "Account")';
                            }, 1500);
                        } else {
                            showNotification(response.message || 'Error updating wishlist', 'error');
                        }
                    }
                },
                error: function(xhr) {
                    console.error('Wishlist error:', xhr);
                    showNotification('Failed to update wishlist. Please try again.', 'error');
                },
                complete: function() {
                    hideLoading();
                    button.disabled = false;
                }
            });
        }
        
        function shareProduct(platform) {
            var url = window.location.href;
            var title = document.title;
            var shareUrl = '';
            
            switch(platform) {
                case 'facebook':
                    shareUrl = 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(url);
                    break;
                case 'twitter':
                    shareUrl = 'https://twitter.com/intent/tweet?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent(title);
                    break;
                case 'pinterest':
                    var img = document.querySelector('.product-img img').src;
                    shareUrl = 'https://pinterest.com/pin/create/button/?url=' + encodeURIComponent(url) + '&media=' + encodeURIComponent(img) + '&description=' + encodeURIComponent(title);
                    break;
            }
            
            if (shareUrl) {
                window.open(shareUrl, '_blank', 'width=600,height=400');
            }
        }
        
        function copyLink() {
            var url = window.location.href;
            navigator.clipboard.writeText(url).then(function() {
                showNotification('Link copied to clipboard!', 'success');
            }).catch(function() {
                // Fallback for browsers that don't support clipboard API
                var tempInput = document.createElement('input');
                tempInput.value = url;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showNotification('Link copied to clipboard!', 'success');
            });
        }
        
        // Function to update cart count in navbar
        function updateCartCount() {
            $.ajax({
                url: '@Url.Action("GetCartCount", "Cart")',
                type: 'GET',
                success: function(count) {
                    $('.cart-count').text(count);
                }
            });
        }
                        } else {
                            icon.classList.remove('bi-heart-fill');
                            icon.classList.add('bi-heart');
                            button.innerHTML = '<i class="bi bi-heart"></i> Add to Wishlist';
                        }
                        
                        showNotification(response.message, 'success');
                    } else {
                        if (response.message.includes('authenticated')) {
                            showNotification('Please login to manage wishlist', 'warning');
                            setTimeout(function() {
                                window.location.href = '@Url.Action("Login", "Account")';
                            }, 1500);
                        } else {
                            showNotification(response.message, 'error');
                        }
                    }
                },
                error: function() {
                    showNotification('Failed to update wishlist', 'error');
                }
            });
        }

        function shareProduct(platform) {
            var url = window.location.href;
            var title = '@Model.Product.Name';
            
            switch(platform) {
                case 'facebook':
                    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
                    break;
                case 'twitter':
                    window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`, '_blank');
                    break;
                case 'whatsapp':
                    window.open(`https://wa.me/?text=${encodeURIComponent(title + ' ' + url)}`, '_blank');
                    break;
            }
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href).then(function() {
                showNotification('Link copied to clipboard!', 'success');
            });
        }

        function showNotification(message, type) {
            // Simple notification system
            var alertClass = type === 'success' ? 'alert-success' : type === 'info' ? 'alert-info' : 'alert-warning';
            var notification = $(`
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 1050; min-width: 300px;">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('body').append(notification);
            
            // Auto-dismiss after 3 seconds
            setTimeout(function() {
                notification.alert('close');
            }, 3000);
        }
        
        // Product card hover effects for recommended products
        $(document).ready(function() {
            $('.product-card').hover(
                function() {
                    $(this).addClass('shadow-lg').removeClass('shadow-sm');
                },
                function() {
                    $(this).addClass('shadow-sm').removeClass('shadow-lg');
                }
            );
        });
        
        // Add to cart function
        function addToCart(productId) {
            $.ajax({
                url: '/Cart/AddToCart',
                type: 'POST',
                data: { productId: productId },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        showNotification('Product added to cart successfully!', 'success');
                        updateCartCount();
                    } else {
                        showNotification(response.message || 'Failed to add product to cart.', 'danger');
                    }
                },
                error: function() {
                    showNotification('An error occurred. Please try again.', 'danger');
                }
            });
        }
        
        // Buy now function
        function buyNow(productId) {
            addToCart(productId);
            setTimeout(function() {
                window.location.href = '/Cart/Index';
            }, 500);
        }
        
        // Toggle wishlist function
        function toggleWishlist(productId) {
            $.ajax({
                url: '/Wishlist/ToggleWishlistItem',
                type: 'POST',
                data: { productId: productId },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        const heartIcon = $('.btn-outline-danger i');
                        const wishlistText = $('.btn-outline-danger').contents().last();
                        
                        if (response.added) {
                            heartIcon.removeClass('bi-heart').addClass('bi-heart-fill');
                            wishlistText.replaceWith(' Remove from Wishlist');
                            showNotification('Product added to wishlist!', 'success');
                        } else {
                            heartIcon.removeClass('bi-heart-fill').addClass('bi-heart');
                            wishlistText.replaceWith(' Add to Wishlist');
                            showNotification('Product removed from wishlist!', 'info');
                        }
                    } else {
                        showNotification(response.message || 'Failed to update wishlist.', 'danger');
                    }
                },
                error: function() {
                    showNotification('An error occurred. Please try again.', 'danger');
                }
            });
        }
        
        // Update cart count
        function updateCartCount() {
            $.ajax({
                url: '/Cart/GetCartCount',
                type: 'GET',
                success: function(response) {
                    $('#cartCount').text(response);
                }
            });
        }
        
        function shareProduct(platform) {
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent('@Model.Product.Name');
            
            let shareUrl = '';
            switch (platform) {
                case 'facebook':
                    shareUrl = 'https://www.facebook.com/sharer/sharer.php?u=' + url;
                    break;
                case 'twitter':
                    shareUrl = 'https://twitter.com/intent/tweet?url=' + url + '&text=' + title;
                    break;
                case 'whatsapp':
                    shareUrl = 'https://wa.me/?text=' + title + ' ' + url;
                    break;
            }
            
            if (shareUrl) {
                window.open(shareUrl, '_blank', 'width=600,height=400');
            }
        }
        
        function copyLink() {
            navigator.clipboard.writeText(window.location.href).then(function() {
                showNotification('Link copied to clipboard!', 'success');
            });
        }
    </script>
}

@* Add toast container for notifications *@
<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

@section Styles {
    <style>
        .product-card {
            transition: all 0.3s ease;
            border: none;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
        }
        
        .product-image {
            transition: transform 0.3s ease;
        }
        
        .product-card:hover .product-image {
            transform: scale(1.05);
        }
        
        #productImage {
            cursor: zoom-in;
        }
        
        .btn-group .btn {
            border-radius: 0.375rem;
        }
        
        .btn-group .btn:not(:last-child) {
            margin-right: 0.25rem;
        }
        
        .rating-input i {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .rating-input i:hover {
            transform: scale(1.2);
        }
        
        .review-item {
            border-bottom: 1px solid #e9ecef;
            padding: 1.5rem 0;
        }
        
        .review-item:last-child {
            border-bottom: none;
        }
        
        /* Image Zoom Styles */
        .product-image-container {
            overflow: hidden;
        }
        
        .product-main-image {
            transition: transform 0.3s ease;
        }
        
        .zoom-lens {
            position: absolute;
            border: 2px solid rgba(255,255,255,0.5);
            width: 150px;
            height: 150px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            pointer-events: none;
            display: none;
        }
        
        /* Gallery Thumbnail Styles */
        .gallery-thumb {
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 2px;
            transition: all 0.2s;
        }
        
        .gallery-thumb:hover, .gallery-thumb.active {
            border-color: var(--bs-primary);
        }
        
        .modal-thumb {
            border: 2px solid transparent;
            border-radius: 4px;
            padding: 2px;
            transition: all 0.2s;
        }
        
        .modal-thumb:hover, .modal-thumb.active {
            border-color: #fff;
        }
        
        /* Variant Button Styles */
        .variant-btn {
            transition: all 0.2s;
        }
        
        .variant-btn.selected {
            background-color: var(--bs-primary);
            color: white;
            border-color: var(--bs-primary);
        }
        
        .variant-btn:disabled {
            opacity: 0.5;
            text-decoration: line-through;
        }
    </style>
    
    <script>
        // Image Zoom Functions
        function openImageModal() {
            var modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
        }
        
        function closeImageModal() {
            var modal = bootstrap.Modal.getInstance(document.getElementById('imageModal'));
            if (modal) modal.hide();
        }
        
        function zoomImage(event) {
            var img = document.getElementById('productImage');
            var lens = document.getElementById('zoomLens');
            var container = document.getElementById('imageContainer');
            
            if (!img || !lens) return;
            
            var rect = container.getBoundingClientRect();
            var x = event.clientX - rect.left;
            var y = event.clientY - rect.top;
            
            // Position lens
            lens.style.display = 'block';
            lens.style.left = (x - 75) + 'px';
            lens.style.top = (y - 75) + 'px';
            
            // Scale image
            img.style.transform = 'scale(1.5)';
            img.style.transformOrigin = x + 'px ' + y + 'px';
        }
        
        function resetZoom() {
            var img = document.getElementById('productImage');
            var lens = document.getElementById('zoomLens');
            
            if (img) img.style.transform = 'scale(1)';
            if (lens) lens.style.display = 'none';
        }
        
        // Image Gallery Functions
        var galleryImages = [@Html.Raw("'" + Model.Product.ImageURL + "'")
            @if (Model.Product.Images != null && Model.Product.Images.Any())
            {
                foreach (var img in Model.Product.Images.OrderBy(i => i.DisplayOrder))
                {
                    @Html.Raw(", '" + img.ImageURL + "'")
                }
            }
        ];
        var currentImageIndex = 0;
        
        function changeMainImage(imageUrl, thumbElement) {
            var mainImage = document.getElementById('productImage');
            if (mainImage) {
                mainImage.src = imageUrl;
            }
            
            // Update active state
            document.querySelectorAll('.gallery-thumb').forEach(t => t.classList.remove('active'));
            if (thumbElement) thumbElement.classList.add('active');
            
            // Update index
            currentImageIndex = galleryImages.indexOf(imageUrl);
        }
        
        function setModalImage(imageUrl, index) {
            var modalImage = document.getElementById('modalImage');
            if (modalImage) {
                modalImage.src = imageUrl;
            }
            
            // Update active state
            document.querySelectorAll('.modal-thumb').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.modal-thumb')[index]?.classList.add('active');
            
            currentImageIndex = index;
        }
        
        function prevModalImage() {
            currentImageIndex = (currentImageIndex - 1 + galleryImages.length) % galleryImages.length;
            setModalImage(galleryImages[currentImageIndex], currentImageIndex);
        }
        
        function nextModalImage() {
            currentImageIndex = (currentImageIndex + 1) % galleryImages.length;
            setModalImage(galleryImages[currentImageIndex], currentImageIndex);
        }
        
        // Product Variant Selection
        var selectedVariants = {};
        var basePrice = @Model.Product.Price;
        
        function selectVariant(button) {
            var variantType = button.dataset.variantType;
            var variantId = button.dataset.variantId;
            var variantValue = button.dataset.variantValue;
            var priceAdjustment = parseFloat(button.dataset.priceAdjustment) || 0;
            
            // Toggle selection for this variant type
            var siblings = button.parentElement.querySelectorAll('.variant-btn');
            siblings.forEach(b => b.classList.remove('selected'));
            button.classList.add('selected');
            
            // Store selection
            selectedVariants[variantType] = {
                id: variantId,
                value: variantValue,
                priceAdjustment: priceAdjustment
            };
            
            // Update price display
            updateDisplayedPrice();
            
            // Update hidden field
            document.getElementById('selectedVariants').value = JSON.stringify(selectedVariants);
        }
        
        function updateDisplayedPrice() {
            var totalAdjustment = 0;
            for (var type in selectedVariants) {
                totalAdjustment += selectedVariants[type].priceAdjustment;
            }
            
            var finalPrice = basePrice + totalAdjustment;
            var priceElement = document.querySelector('.text-success.fw-bold');
            if (priceElement) {
                priceElement.textContent = finalPrice.toFixed(2) + ' L.E';
            }
        }
        
        // Reviews functionality
        const productId = @Model.Product.ProductID;
        
        // Load reviews on page load
        $(document).ready(function() {
            loadReviews();
        });
        
        // Load reviews via AJAX
        function loadReviews() {
            $.ajax({
                url: '@Url.Action("GetReviews", "Review")',
                type: 'GET',
                data: { productId: productId },
                success: function(response) {
                    if (response.success) {
                        displayReviews(response.reviews);
                        updateAverageRating(response.averageRating, response.totalCount);
                    } else {
                        $('#reviewsContainer').html('<p class="text-muted text-center py-4">No reviews yet. Be the first to review!</p>');
                    }
                },
                error: function() {
                    $('#reviewsContainer').html('<p class="text-danger text-center py-4">Failed to load reviews</p>');
                }
            });
        }
        
        // Display reviews
        function displayReviews(reviews) {
            if (!reviews || reviews.length === 0) {
                $('#reviewsContainer').html('<p class="text-muted text-center py-4">No reviews yet. Be the first to review!</p>');
                return;
            }
            
            let html = '';
            reviews.forEach(review => {
                const stars = generateStars(review.rating);
                const date = new Date(review.reviewDate).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                html += `
                    <div class="review-item">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">${review.userName || 'Anonymous'}</h6>
                                <div class="text-warning">${stars}</div>
                            </div>
                            <small class="text-muted">${date}</small>
                        </div>
                        <p class="mb-0">${review.comment}</p>
                    </div>
                `;
            });
            
            $('#reviewsContainer').html(html);
        }
        
        // Generate star HTML
        function generateStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="bi bi-star-fill"></i>';
                } else {
                    stars += '<i class="bi bi-star"></i>';
                }
            }
            return stars;
        }
        
        // Update average rating display
        function updateAverageRating(avgRating, count) {
            $('#avgRatingText').text(avgRating.toFixed(1));
            $('#reviewCountText').text(count);
            $('#avgStars').html(generateStars(Math.round(avgRating)));
        }
        
        // Set rating when clicking stars
        function setRating(rating) {
            $('#rating').val(rating);
            $('#ratingError').addClass('d-none');
            
            $('.rating-input i').each(function(index) {
                if (index < rating) {
                    $(this).removeClass('bi-star text-muted').addClass('bi-star-fill text-warning');
                } else {
                    $(this).removeClass('bi-star-fill text-warning').addClass('bi-star text-muted');
                }
            });
        }
        
        // Submit review form
        $('#reviewForm').on('submit', function(e) {
            e.preventDefault();
            
            const rating = $('#rating').val();
            const comment = $('#comment').val().trim();
            
            // Validation
            let isValid = true;
            if (rating == 0) {
                $('#ratingError').removeClass('d-none');
                isValid = false;
            }
            if (comment === '') {
                $('#commentError').removeClass('d-none');
                isValid = false;
            } else {
                $('#commentError').addClass('d-none');
            }
            
            if (!isValid) return;
            
            // Disable submit button
            const submitBtn = $('#submitReviewBtn');
            submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Submitting...');
            
            $.ajax({
                url: '@Url.Action("AddReview", "Review")',
                type: 'POST',
                data: {
                    productId: productId,
                    rating: rating,
                    comment: comment
                },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        showNotification(response.message, 'success');
                        // Reset form
                        $('#reviewForm')[0].reset();
                        setRating(0);
                        // Reload reviews
                        loadReviews();
                    } else {
                        showNotification(response.message, 'error');
                    }
                },
                error: function() {
                    showNotification('Failed to submit review. Please try again.', 'error');
                },
                complete: function() {
                    submitBtn.prop('disabled', false).html('<i class="bi bi-send"></i> Submit Review');
                }
            });
        });
    </script>
}
