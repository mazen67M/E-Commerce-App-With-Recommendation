@model Ecommerce.Application.ViewModels.Admin_Panel.EditProductViewModel
@{
    ViewData["Title"] = "Edit Product";
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Dashboard" asp-action="Index">Dashboard</a></li>
                    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="ProductManagement" asp-action="Index">Product Management</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Edit Product</li>
                </ol>
            </nav>
            <h1 class="display-6 fw-bold text-primary">
                <i class="bi bi-pencil-square"></i> Edit Product
            </h1>
            <p class="text-muted">Update product information</p>
        </div>
    </div>

    <!-- Product Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Product Information</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Edit" method="post" enctype="multipart/form-data">
                        <input asp-for="ProductID" type="hidden" />
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                        <!-- Basic Information -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label asp-for="Name" class="form-label">Product Name <span class="text-danger">*</span></label>
                                <input asp-for="Name" class="form-control" placeholder="Enter product name">
                                <span asp-validation-for="Name" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label asp-for="Description" class="form-label">Description</label>
                                <textarea asp-for="Description" class="form-control" rows="4" 
                                          placeholder="Enter detailed product description"></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Price and Stock -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="Price" class="form-label">Price <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input asp-for="Price" class="form-control" type="number" step="0.01" min="0.01" 
                                           placeholder="0.00">
                                </div>
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="StockQuantity" class="form-label">Stock Quantity</label>
                                <input asp-for="StockQuantity" class="form-control" type="number" min="0" 
                                       placeholder="Enter stock quantity">
                                <span asp-validation-for="StockQuantity" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Category and Brand -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="CategoryID" class="form-label">Category <span class="text-danger">*</span></label>
                                <select asp-for="CategoryID" asp-items="Model.Categories" class="form-select">
                                    <option value="">Select a category</option>
                                </select>
                                <span asp-validation-for="CategoryID" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="BrandID" class="form-label">Brand</label>
                                <select asp-for="BrandID" asp-items="Model.Brands" class="form-select">
                                    <option value="">Select a brand (optional)</option>
                                </select>
                                <span asp-validation-for="BrandID" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Image Upload -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label asp-for="ImageURL" class="form-label">Product Image</label>
                                <div class="mb-2">
                                    <input type="file" class="form-control" id="imageUpload" accept="image/*" onchange="previewImage(this)">
                                    <div class="form-text">Upload a new product image (JPG, PNG, GIF). Max size: 5MB</div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Or enter image URL:</label>
                                    <input asp-for="ImageURL" class="form-control" placeholder="https://example.com/image.jpg">
                                    <span asp-validation-for="ImageURL" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Tags -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label class="form-label">Product Tags</label>
                                <div class="border rounded p-3">
                                    @if (Model.Tags != null && Model.Tags.Any())
                                    {
                                        @foreach (var tag in Model.Tags)
                                        {
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" name="SelectedTagIds" 
                                                       value="@tag.Value" id="tag_@tag.Value"
                                                       @(Model.SelectedTagIds.Contains(int.Parse(tag.Value)) ? "checked" : "")>
                                                <label class="form-check-label" for="tag_@tag.Value">
                                                    @tag.Text
                                                </label>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <p class="text-muted mb-0">No tags available. You can add tags later.</p>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a asp-action="Index" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-left"></i> Back to Products
                                    </a>
                                    <div>
                                        <a asp-action="Details" asp-route-id="@Model.ProductID" class="btn btn-outline-info me-2">
                                            <i class="bi bi-eye"></i> View Details
                                        </a>
                                        <button type="submit" class="btn btn-warning">
                                            <i class="bi bi-check-circle"></i> Update Product
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-eye"></i> Live Preview</h5>
                </div>
                <div class="card-body">
                    <div id="productPreview">
                        <!-- Product Image Preview -->
                        <div class="mb-3">
                            <div id="imagePreview" class="border rounded d-flex align-items-center justify-content-center bg-light" 
                                 style="height: 200px;">
                                @if (!string.IsNullOrEmpty(Model.ImageURL))
                                {
                                    <img src="@Model.ImageURL" alt="Preview" style="width: 100%; height: 100%; object-fit: cover;">
                                }
                                else
                                {
                                    <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                                }
                            </div>
                        </div>

                        <!-- Product Info Preview -->
                        <div class="mb-2">
                            <h5 id="namePreview" class="text-muted">@Model.Name</h5>
                        </div>
                        
                        <div class="mb-2">
                            <span id="categoryPreview" class="badge bg-secondary">Category</span>
                            <span id="brandPreview" class="badge bg-info ms-1" style="display: none;">Brand</span>
                        </div>

                        <div class="mb-2">
                            <h4 id="pricePreview" class="text-success">@Model.Price.ToString("C")</h4>
                        </div>

                        <div class="mb-3">
                            <p id="descriptionPreview" class="text-muted small">@Model.Description</p>
                        </div>

                        <div class="mb-2">
                            <small class="text-muted">Stock: <span id="stockPreview">@Model.StockQuantity</span> units</small>
                        </div>

                        <div id="tagsPreview" class="mb-3">
                            <!-- Selected tags will appear here -->
                        </div>

                        <div class="d-grid">
                            <button class="btn btn-primary" disabled>
                                <i class="bi bi-cart-plus"></i> Add to Cart
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Change History Card -->
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="bi bi-clock-history"></i> Recent Changes</h6>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <small class="text-muted">Last updated: Today at 2:30 PM</small>
                            <p class="mb-1">Price updated from $99.99 to $@Model.Price</p>
                        </div>
                        <div class="timeline-item">
                            <small class="text-muted">Yesterday at 4:15 PM</small>
                            <p class="mb-1">Product description updated</p>
                        </div>
                        <div class="timeline-item">
                            <small class="text-muted">2 days ago</small>
                            <p class="mb-0">Product created</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Live preview functionality (same as Create page)
        document.addEventListener('DOMContentLoaded', function() {
            // Update preview when form fields change
            document.getElementById('Name').addEventListener('input', updatePreview);
            document.getElementById('Description').addEventListener('input', updatePreview);
            document.getElementById('Price').addEventListener('input', updatePreview);
            document.getElementById('StockQuantity').addEventListener('input', updatePreview);
            document.getElementById('CategoryID').addEventListener('change', updatePreview);
            document.getElementById('BrandID').addEventListener('change', updatePreview);
            document.getElementById('ImageURL').addEventListener('input', updateImagePreview);

            // Update tags preview when checkboxes change
            document.querySelectorAll('input[name="SelectedTagIds"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateTagsPreview);
            });

            // Initial preview update
            updatePreview();
        });

        function updatePreview() {
            const name = document.getElementById('Name').value || 'Product Name';
            const description = document.getElementById('Description').value || 'Product description will appear here...';
            const price = document.getElementById('Price').value || '0.00';
            const stock = document.getElementById('StockQuantity').value || '0';
            
            const categorySelect = document.getElementById('CategoryID');
            const brandSelect = document.getElementById('BrandID');
            
            const categoryText = categorySelect.options[categorySelect.selectedIndex]?.text || 'Category';
            const brandText = brandSelect.options[brandSelect.selectedIndex]?.text;

            document.getElementById('namePreview').textContent = name;
            document.getElementById('descriptionPreview').textContent = description;
            document.getElementById('pricePreview').textContent = '$' + parseFloat(price).toFixed(2);
            document.getElementById('stockPreview').textContent = stock;
            document.getElementById('categoryPreview').textContent = categoryText;

            const brandPreview = document.getElementById('brandPreview');
            if (brandText && brandText !== 'Select a brand (optional)') {
                brandPreview.textContent = brandText;
                brandPreview.style.display = 'inline';
            } else {
                brandPreview.style.display = 'none';
            }

            updateTagsPreview();
        }

        function updateImagePreview() {
            const imageUrl = document.getElementById('ImageURL').value;
            const imagePreview = document.getElementById('imagePreview');
            
            if (imageUrl) {
                imagePreview.innerHTML = `<img src="${imageUrl}" alt="Preview" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                imagePreview.innerHTML = '<i class="bi bi-image text-muted" style="font-size: 3rem;"></i>';
            }
        }

        function updateTagsPreview() {
            const selectedTags = [];
            document.querySelectorAll('input[name="SelectedTagIds"]:checked').forEach(checkbox => {
                const label = document.querySelector(`label[for="${checkbox.id}"]`);
                if (label) {
                    selectedTags.push(label.textContent.trim());
                }
            });

            const tagsPreview = document.getElementById('tagsPreview');
            if (selectedTags.length > 0) {
                tagsPreview.innerHTML = selectedTags.map(tag => 
                    `<span class="badge bg-light text-dark me-1">#${tag}</span>`
                ).join('');
            } else {
                tagsPreview.innerHTML = '';
            }
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imagePreview = document.getElementById('imagePreview');
                    imagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="width: 100%; height: 100%; object-fit: cover;">`;
                    
                    // Clear the URL input when file is selected
                    document.getElementById('ImageURL').value = '';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Form validation enhancement
        document.querySelector('form').addEventListener('submit', function(e) {
            const name = document.getElementById('Name').value.trim();
            const price = document.getElementById('Price').value;
            const category = document.getElementById('CategoryID').value;

            if (!name) {
                e.preventDefault();
                showNotification('Product name is required', 'error');
                return;
            }

            if (!price || parseFloat(price) <= 0) {
                e.preventDefault();
                showNotification('Valid price is required', 'error');
                return;
            }

            if (!category) {
                e.preventDefault();
                showNotification('Please select a category', 'error');
                return;
            }

            // Show loading state
            const submitBtn = document.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Updating Product...';
            submitBtn.disabled = true;
        });

        function showNotification(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const notification = $(`
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 1050; min-width: 300px;">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('body').append(notification);
            
            setTimeout(function() {
                notification.alert('close');
            }, 3000);
        }
    </script>
}

@section Styles {
    <style>
        .form-label {
            font-weight: 600;
        }
        
        .card-header {
            border-bottom: 1px solid #dee2e6;
        }
        
        #imagePreview {
            border: 2px dashed #dee2e6;
            transition: border-color 0.3s ease;
        }
        
        #imagePreview:hover {
            border-color: #0d6efd;
        }
        
        .timeline-item {
            border-left: 2px solid #dee2e6;
            padding-left: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -5px;
            top: 5px;
            width: 8px;
            height: 8px;
            background-color: #ffc107;
            border-radius: 50%;
        }
        
        .timeline-item:last-child {
            margin-bottom: 0;
        }
    </style>
}
